<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filma</title>
    <script>
        async function BalorazioaBidalli(movieId) {
            const puntuacion = document.getElementById('puntuacion').value;
            const comentario = document.getElementById('comentario').value;

            const response = await fetch(`/rate/${movieId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ puntuacion: parseInt(puntuacion), comentario })
            });

            if (response.ok) {
                alert("¡Gracias por tu valoración!");
                cargarValoraciones(movieId);
            } else {
                const error = await response.json();
                alert(`Error: ${error.message}`);
            }
        }

        async function cargarValoraciones(movieId) {
            const response = await fetch(`/ratings/${movieId}`);
            const valoraciones = await response.json();

            const valoracionesDiv = document.getElementById('valoraciones');
            valoracionesDiv.innerHTML = '';

            valoraciones.forEach(v => {
                const valoracionElement = document.createElement('div');
                valoracionElement.innerHTML = `
                    <p><strong>Usuario:</strong> ${v.usuario_id}</p>
                    <p><strong>Puntuación:</strong> ${v.puntuacion}</p>
                    <p><strong>Comentario:</strong> ${v.comentario}</p>
                    <p><em>${v.fecha}</em></p>
                    <hr>
                `;
                valoracionesDiv.appendChild(valoracionElement);
            });
        }
    </script>
</head>
<body>
    <h1>Detalles de la Película</h1>

    <!-- Formulario de Valoración -->
    <div id="rating-section">
        <h1>Valorar Película</h1>
        <form action="{{ url_for('submit_balorazioa') }}" method="post">
            <label for="puntuazioa">Puntuación (1-5):</label>
            <input type="number" id="puntuazioa" name="puntuazioa" min="1" max="5" required>
            
            <label for="iruzkina">Comentario (opcional):</label>
            <textarea id="iruzkina" name="iruzkina" rows="4" cols="50"></textarea>
            
            <input type="hidden" name="kodeFilma" value="{{ kodeFilma }}">
            <button type="submit">Enviar Valoración</button>
        </form>
    </div>
    <!-- Tabla de Valoraciones -->
    <div id="valoraciones-section">
        <h3>Valoraciones de la película</h3>
        <table>
            <thead>
                <tr>
                    <th>Puntuación</th>
                    <th>Descripción de la Valoración</th>
                </tr>
            </thead>
            <tbody id="valoraciones">
                
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            cargarValoraciones(123); // Cargar valoraciones al cargar la página
        });

        async function cargarValoraciones(movieId) {
            const response = await fetch(`/get_balorazioak`);
            const valoraciones = await response.json();

            const valoracionesTbody = document.getElementById('valoraciones');
            valoracionesTbody.innerHTML = '';

            valoraciones.forEach(v => {
                const valoracionRow = document.createElement('tr');
                valoracionRow.innerHTML = `
                    <td>${v.puntuazioa}</td>
                    <td>${v.iruzkina}</td>
                `;
                valoracionesTbody.appendChild(valoracionRow);
            });
        }
    </script>
</body>
</html>
